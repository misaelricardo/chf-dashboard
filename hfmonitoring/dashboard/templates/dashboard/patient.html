{% load static %}
<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>{{ patient.first_name }} {{ patient.last_name }}</title>


    <style>
        @media print {

            /* Hide everything in the body by default */
            body>* {
                display: none;
            }

            /* Make ONLY the report modal visible */
            #reportModal {
                display: block;
            }

            /* Reset the modal's layout for printing */
            #reportModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: white;
                overflow: visible;
            }

            /* Remove the modal's container styling and use the correct property */
            #reportModal>div {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 1rem !important;
                max-width: 100% !important;
                max-height: none !important;
                /* CORRECTED: This is the proper CSS property */
            }

            /* Hide any element with the 'no-print' class */
            .no-print {
                display: none !important;
            }
        }
    </style>

</head>

<body class="h-full m-0 p-0 overflow-auto">

    <!-- Full height flex layout -->
    <div class="flex h-full">

        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col">
            <h1 class="text-2xl font-bold text-blue-600 mb-6">CHF Dashboard</h1>
            <div class="mb-3">
                <div id="patient-search-dropdown-container" class="relative"> <label for="patient-search-input"
                        class="block text-sm font-medium text-gray-700 mb-2">Search or
                        Select Patient</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="patient-search-input" name="patient-search"
                            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm shadow-sm"
                            placeholder="{{ patient.first_name }} {{ patient.last_name }}" autocomplete="off">
                    </div>
                    <div id="patient-results-list"
                        class="absolute z-10 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden"
                        style="width: calc(100% - 0px); left: 0px; box-sizing: border-box;"> </div>
                </div>
            </div>
            <div class="mt-3">
                <label for="time-period-select" class="block text-sm font-medium text-gray-700 mb-1">
                    Filter by Time Period
                </label>
                <select id="time-period-select" class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 bg-white
                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                   cursor-pointer">
                    <option value="" disabled selected></option>
                </select>
            </div>
            <div class="pt-4 border-t border-gray-200 mt-4">
                <button id="openReportModalBtn"
                    class="w-full flex items-center justify-center p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 shadow-sm transition-colors group">
                    <svg class="w-5 h-5 text-blue-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span class="ms-2 font-semibold">Generate Report</span>
                </button>
            </div>
            <div class="pt-4 mt-auto border-t border-gray-200">
                <a href="{% url 'logout' %}"
                    class="w-full flex items-center justify-center p-2 rounded-lg text-red-600 hover:bg-red-50 group">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    <span class="ms-2 font-semibold">Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1 p-10 bg-gray-100 overflow-auto h-full">
            <!-- Unified container for all main content card blocks -->
            <div class="flex flex-col gap-6"> <!-- This container now controls all vertical spacing -->


                <!-- Patient's profile card -->
                <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-2xl">

                    <!-- Group for Name and ID -->
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">
                            {{ patient.first_name }} {{ patient.last_name }}
                        </h2>
                        <p class="text-sm text-gray-500"><span class="font-medium">ID:</span> {{ patient_id }}</p>
                    </div>

                    <!-- Grid layout for other details -->
                    <div class="grid grid-cols-2 gap-x-8 text-gray-600">
                        <!-- Left Column -->
                        <div class="space-y-2">
                            <p><span class="font-medium">Sex:</span> <span class="font-medium">{{patient.sex}}</span>
                            </p>
                            <p><span class="font-medium">Date of Birth:</span> <span
                                    class="font-medium">{{patient.date_of_birth}}</span></p>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-2">
                            <p><span class="font-medium">Phone:</span> <span
                                    class="font-medium">{{contacts_phone}}</span></p>
                            <p><span class="font-medium">Email:</span> <span
                                    class="font-medium">{{contacts_email}}</span></p>
                        </div>
                    </div>
                </div>

                <!-- Heart Rate Chart Card -->
                <div class="bg-white shadow-md rounded-lg p-6 w-full" style="height: 400px;">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Heart Rate</h3>
                    <div class="flex flex-col lg:flex-row gap-6 h-full pb-10">
                        <div
                            class="flex flex-col justify-center items-center w-full lg:w-1/4 border-b lg:border-b-0 lg:border-r border-gray-200 pb-4 lg:pb-0 lg:pr-6">
                            <p class="text-gray-500">Latest Heart Rate</p>
                            <p class="text-5xl font-bold mt-1
                        {% if latest_heart_rate >= HR_NORMAL_MIN and latest_heart_rate <= HR_NORMAL_MAX %}
                            text-blue-500 
                        {% else %}
                            text-red-500 
                        {% endif %}">
                                {{ latest_heart_rate }} bpm
                            </p>
                        </div>

                        <!-- Chart Section -->
                        <div class="flex-1">
                            <canvas id="heartRateChart" data-timestamps='{{ timestamps|safe }}'
                                data-heart-rates='{{ heart_rate_values|safe }}' data-hr-normal-min='{{ HR_NORMAL_MIN }}'
                                data-hr-normal-max='{{ HR_NORMAL_MAX }}' style="width: 100%; height: 100%;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Blood Pressure Chart Card -->
                <div class="bg-white shadow-md rounded-lg p-6 w-full" style="height: 400px;"> <!-- Removed mt-8 -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Blood Pressure</h3>
                    </div>
                    <div class="flex flex-col lg:flex-row gap-6 h-full pb-10"> {# Added pb-10 here #}
                        <div
                            class="flex flex-col justify-center items-center w-full lg:w-1/4 border-b lg:border-b-0 lg:border-r border-gray-200 pb-4 lg:pb-0 lg:pr-6">
                            <p class="text-gray-500">Latest Blood Pressure</p>
                            <p class="text-4xl font-bold mt-1
                        {# BP Categories Logic #}
                        {% if latest_systolic_bp >= BP_STAGE2_SYSTOLIC_MIN or latest_diastolic_bp >= BP_STAGE2_DIASTOLIC_MIN %}
                            text-red-500 {# Stage 2 Hypertension (Critical) #}
                        {% elif latest_systolic_bp >= BP_STAGE1_SYSTOLIC_MIN and latest_systolic_bp <= BP_STAGE1_SYSTOLIC_MAX or latest_diastolic_bp >= BP_STAGE1_DIASTOLIC_MIN and latest_diastolic_bp <= BP_STAGE1_DIASTOLIC_MAX %}
                            text-orange-500 {# Stage 1 Hypertension (Caution) #}
                        {% elif latest_systolic_bp >= BP_ELEVATED_SYSTOLIC_MIN and latest_systolic_bp <= BP_ELEVATED_SYSTOLIC_MAX and latest_diastolic_bp < BP_ELEVATED_DIASTOLIC_MAX %}
                            text-yellow-500 {# Elevated #}
                        {% elif latest_systolic_bp < BP_NORMAL_SYSTOLIC_MAX and latest_diastolic_bp < BP_NORMAL_DIASTOLIC_MAX %}
                            text-blue-500 {# Changed from text-green-500 to text-blue-500 for Normal #}
                        {% else %}
                            text-gray-500 {# Default if none of the above #}
                        {% endif %}">
                                {{ latest_systolic_bp }}/{{latest_diastolic_bp}} mmHg
                            </p>
                        </div>

                        <div class="flex-1 ">
                            <canvas id="bpChart" data-timestamps='{{ timestamps|safe }}'
                                data-systolic='{{ systolic_bp_values|safe }}'
                                data-diastolic='{{ diastolic_bp_values|safe }}'
                                data-bp-normal-systolic-max='{{ BP_NORMAL_SYSTOLIC_MAX }}'
                                data-bp-normal-diastolic-max='{{ BP_NORMAL_DIASTOLIC_MAX }}'
                                data-bp-elevated-systolic-min='{{ BP_ELEVATED_SYSTOLIC_MIN }}'
                                data-bp-elevated-systolic-max='{{ BP_ELEVATED_SYSTOLIC_MAX }}'
                                data-bp-elevated-diastolic-max='{{ BP_ELEVATED_DIASTOLIC_MAX }}'
                                data-bp-stage1-systolic-min='{{ BP_STAGE1_SYSTOLIC_MIN }}'
                                data-bp-stage1-systolic-max='{{ BP_STAGE1_SYSTOLIC_MAX }}'
                                data-bp-stage1-diastolic-min='{{ BP_STAGE1_DIASTOLIC_MIN }}'
                                data-bp-stage1-diastolic-max='{{ BP_STAGE1_DIASTOLIC_MAX }}'
                                data-bp-stage2-systolic-min='{{ BP_STAGE2_SYSTOLIC_MIN }}'
                                data-bp-stage2-diastolic-min='{{ BP_STAGE2_DIASTOLIC_MIN }}'
                                style="width: 100%; height: 100%;"></canvas>
                        </div>

                    </div>
                </div>

                <!-- Oxygen Saturation Card -->
                <div class="bg-white shadow-md rounded-lg p-6 w-full" style="height: 400px;"> <!-- Removed mt-8 -->
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Oxygen Saturation</h3>
                    <div class="flex flex-col lg:flex-row gap-6 h-full pb-10"> {# Added pb-10 here #}

                        <!-- Latest Value Section (now on the left) -->
                        <div
                            class="flex flex-col justify-center items-center w-full lg:w-1/4 border-b lg:border-b-0 lg:border-r border-gray-200 pb-4 lg:pb-0 lg:pr-6">
                            <p class="text-gray-500">Latest SpOâ‚‚</p>
                            <p class="text-7xl font-bold mt-2
                                {% if latest_sp02 >= SPO2_CAUTION_THRESHOLD %}
                                    text-blue-500
                                {% elif latest_sp02 >= SPO2_CRITICAL_THRESHOLD %}
                                    text-yellow-500
                                {% else %}
                                    text-red-500
                                {% endif %}">
                                {{ latest_sp02 }}%
                            </p>
                        </div>

                        <!-- Chart Section -->
                        <div class="flex-1">
                            <canvas id="spO2Chart" data-timestamps='{{ timestamps|safe }}'
                                data-sp02values='{{ sp02_values|safe }}'
                                data-spo2-critical='{{ SPO2_CRITICAL_THRESHOLD }}'
                                data-spo2-caution='{{ SPO2_CAUTION_THRESHOLD }}'
                                style="width: 100%; height: 100%;"></canvas>
                        </div>

                    </div>
                </div>

                <!-- Weight & Height Cards Group -->
                <div class="flex flex-wrap gap-6 justify-center"> <!-- Removed mt-4 -->
                    <!-- Weight Chart Card -->
                    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-4xl" style="height: 400px;">
                        <!-- Removed mt-8 -->
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Weight</h3>
                        <div class="flex flex-col lg:flex-row gap-6 h-full pb-10"> {# Added pb-10 here #}
                            <!-- Latest Value Section (now on the left) -->
                            <div
                                class="flex flex-col justify-center items-center w-full lg:w-1/4 border-b lg:border-b-0 lg:border-r border-gray-200 pb-4 lg:pb-0 lg:pr-6">
                                <p class="text-gray-500">Latest Weight</p>
                                <p class="text-5xl font-bold {{ latest_weight_color_class }} mt-1">
                                    {{ latest_weight }} Kg
                                </p>
                            </div>

                            <!-- Chart Section -->
                            <div class="flex-1">
                                <canvas id="weightChart" data-timestamps='{{ timestamps|safe }}'
                                    data-weights='{{ weight_values|safe }}'
                                    data-weight-daily-increase-critical='{{ WEIGHT_DAILY_INCREASE_CRITICAL_KG }}'
                                    style="width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Height Chart Card -->
                    <div class="bg-white shadow-md rounded-lg p-6 w-64 text-center" style="height: 400px;">
                        <!-- Removed mt-8 -->
                        <h3 class="text-md font-semibold text-gray-700 mb-2">Latest Height</h3>
                        <div class="flex flex-col justify-center items-center h-full"> {# Changed h-40 to h-full #}
                            <p class="text-7xl font-bold text-blue-500">
                                {{ latest_height }}<span class="text-2xl">cm</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- BMI Card -->
                <div class="bg-white shadow-md rounded-lg p-6 w-full" style="height: 400px;"> <!-- Removed mt-8 -->
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Body Mass Index</h3>
                    <div class="flex flex-col lg:flex-row gap-6 h-full pb-10"> {# Added pb-10 here #}

                        <!-- Latest Value Section (now on the left) -->
                        <div
                            class="flex flex-col justify-center items-center w-full lg:w-1/4 border-b lg:border-b-0 lg:border-r border-gray-200 pb-4 lg:pb-0 lg:pr-6">
                            <p class="text-gray-500">Latest BMI</p>
                            <p class="text-5xl font-bold text-blue-500 mt-1">
                                {{ latest_bmi }}
                            </p>
                        </div>

                        <!-- Chart Section -->
                        <div class="flex-1">
                            <canvas id="bmiChart" data-timestamps='{{ timestamps|safe }}'
                                data-bmis='{{ bmi_values|safe }}' style="width: 100%; height: 100%;"></canvas>
                        </div>

                    </div>
                </div>



            </div> <!-- End of unified container -->
        </main>

    </div>

    <!-- MODIFIED: Date Range Selection Modal -->
    <div id="datePickerModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Select a time period for the report</h2>
                <button id="closeDatePickerModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <!-- NEW: Preset date range buttons -->
            <div class="mt-4 space-y-3">
                <button id="report-last-2-weeks"
                    class="w-full text-center p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-blue-800 font-semibold transition-colors shadow-sm border border-blue-200">
                    Last 2 Weeks
                </button>
                <button id="report-last-1-month"
                    class="w-full text-center p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-blue-800 font-semibold transition-colors shadow-sm border border-blue-200">
                    Last 1 Month
                </button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 m-4 max-w-6xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 id="report-title" class="text-2xl font-bold text-gray-800">Patient's Health Report</h2>
                <button id="closeReportModalBtn"
                    class="no-print text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="reportContent" class="space-y-6 overflow-y-auto flex-grow pr-4">
                <!-- Report data will be dynamically injected here -->
            </div>
            <div class="text-right mt-8 flex-shrink-0">
                <button onclick="window.print()"
                    class="no-print bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">
                    Print Report
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/display_chart.js' %}"></script>
    <script src="{% static 'js/monthList.js' %}"></script>
    <script src="{% static 'js/dropdown.js' %}"></script>
    <script src="{% static 'js/patient_search.js' %}"></script>
    <script src="{% static 'js/report_generator.js' %}"></script>
</body>

</html>